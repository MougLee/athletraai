# Onboarding — Step 2 (Fitness Background)

This document specifies **Step 2** of onboarding. It covers the **UI**, **localStorage**, and the exact **backend mapping on final submit**. Built for the same Bootstrap 5 setup and brand colors used in Step 1.

> General rules (inherited from Step 1):
> - **Persist at end only** — save this step to localStorage; make **one** server call on final submit.
> - **One transaction on submit** — backend: upsert profile/preferences; close+insert assessment; bulk insert injuries/goals; return IDs.
> - **IDs** — generated by backend (64‑hex TEXT) where applicable.

---

## Frontend spec

**Title:** `Fitness background`

**Subtitle:** `This helps us choose a safe starting point and progress pace.`

### Fields
1. **Experience level** *(required)*  
   UX labels → stored value:
   - `Novice` → `novice`  
   - `Intermediate` → `intermediate`  
   - `Advanced` → `advanced`  
   - `Expert` → `expert`

2. **Body description** *(optional, neutral)*  
   Values stored as-is (string): `Athletic`, `Average`, `Carrying extra weight`, `Rebuilding fitness`, `Prefer not to say`

3. **Structure & consistency in the last year** *(required)*  
   UX → boolean mapping for `hasConsistentTraining`:
   - `Very structured & consistent` → `true`
   - `Somewhat structured & consistent` → `true`
   - `Irregular & unstructured` → `false`
   - `Not training consistently` → `false`

4. **If irregular / not training: Break length** *(required in that case)*  
   Values (stored as text): `Less than 3 months`, `3–6 months`, `6–12 months`, `Over 12 months`

5. **Optional: What caused your break?** *(multi-select + “Other” text)*  
   Tag codes: `injury`, `time`, `life_events`, `motivation`, `other`  
   If **Other** text is provided: add the `other` tag and store the free text (trim to 250 chars). If empty after trim, keep only the tag.

### Validation (frontend)
- **experience level:** required
- **hasConsistentTraining:** required
- **inactivityDuration:** required **iff** `hasConsistentTraining === false`
- **consistencyIssuesText:** optional; if provided, ensure `other` exists in tags (UI can auto‑add)

### Local storage
- **Key:** `onboarding/step2/v1/<userId>`
- **Slice saved by Step 2:**
```json
{
  "background": {
    "experienceLevel": "novice",                
    "currentBuild": "Rebuilding fitness",      
    "hasConsistentTraining": false,
    "inactivityDuration": "6–12 months",
    "consistencyIssueTags": ["time","motivation","other"],
    "consistencyIssuesText": "New baby + shift work"
  }
}
```

### Zod (example)
```ts
export const Step2Schema = z.object({
  experienceLevel: z.enum(['novice','intermediate','advanced','expert']),
  currentBuild: z.string().optional(),
  hasConsistentTraining: z.boolean(),
  inactivityDuration: z.string().optional().refine(
    (v, ctx) => (ctx.parent?.hasConsistentTraining ? true : !!v),
    { message: 'Select break length' }
  ),
  consistencyIssueTags: z.array(z.enum(['injury','time','life_events','motivation','other'])).optional(),
  consistencyIssuesText: z.string().max(250).optional()
}).refine(
  (v) => {
    if (v.consistencyIssuesText && !v.consistencyIssueTags?.includes('other')) return false;
    return true;
  },
  { message: "Add 'Other' tag when providing custom reason.", path: ['consistencyIssueTags'] }
);
```

---

## Backend mapping (on final submit)
All Step 2 fields populate the **same** `user_profile_assessments` row that is created during the single transaction (together with Step 1 values like `activity_level` and later Step 6 training preferences).

**`user_profile_assessments` (insert)**
- `user_id` — from auth
- `activity_level` — from Step 1 (already included in the same insert payload)
- `experience_level` — from Step 2
- `current_build` — from Step 2 (optional)
- `has_consistent_training` — from Step 2
- `inactivity_duration` — from Step 2 (only when not consistent)
- `consistency_issue_tags` — from Step 2 (array, optional)
- `consistency_issues` — from Step 2 “Other” free text (optional)
- `valid_from` = NOW(), `valid_to` = NULL

**Transaction recap (same submit request):**
1) Upsert `user_profiles` (from Step 1).  
2) Insert baseline `measurements` if provided (from Step 1).  
3) Close current assessment (`valid_to = NOW()` where `valid_to IS NULL`).  
4) **Insert one new `user_profile_assessments` row** with fields from Step 1 + Step 2 (+ Step 6 prefs when present).  
5) Bulk insert injuries & goals (from later steps).  
6) Commit.

### DB assumption
- The table **has** `experience_level` (TEXT/VARCHAR).  
- You **dropped** `fitness_level` (no longer used).

### Flyway snippet (only if you still have `fitness_level`)
```sql
-- Vx__drop_fitness_level_from_assessments.sql
ALTER TABLE user_profile_assessments
  DROP COLUMN IF EXISTS fitness_level;
```

---

## Test checklist
- **UI**: required fields enforced; break length conditionally required.
- **LocalStorage**: clicking Next writes the Step 2 slice under `onboarding/step2/v1/<userId>`; reload resumes values.
- **Backend**: final submit includes `experience_level` and consistency fields in the inserted assessment; `fitness_level` is not referenced.

---

## Notes
- Keep tags governed (`injury`, `time`, `life_events`, `motivation`, `other`); store nuance in `consistency_issues` free text.  
- You can add an optional **AI normalizer** later to map some “Other” texts to an existing tag while retaining the raw text.

